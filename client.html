<!DOCTYPE html>
<html>
   <head>
   <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
      <script src="/socket.io/socket.io.js"></script>
      
   </head>
   <body>
      <div id='displayUser'></div>
      <div id='rooms' style="position: absolute; right: 200px"></div>
      <div id='AllUsers'></div>
      <div id='RoomUsers'></div>
      

      <input type="text" id="newRoom">
      <button onclick="createRoom()">create room</button>
      
      <!--from http://www.w3schools.com/howto/howto_css_modals.asp -->
      <div id="userModal" class="modal" style="display: none; position: fixed; z-index: 1; background-color: rgba(0,0,0,.5); width: 80%">
         <div class="modal-content" style="background-color: #ff7272; margin: 15% auto; padding: 20px; border: 2px solid; width: 30%;">
            Send Message:
            <input type="text" id="dmtext">
            <button id='dm'>Message</button>
            <button id='kick'>Kick</button>
            <button id='ban'>Ban from Room</button>
         </div>
      </div>

      <input type="text" id="message_input"/>
      <button onclick="sendMessage()">send</button>
      <div id="chatlog"></div>
   

   <script type ="text/javascript">
      var socketio = io.connect();
      var user ='';
      var room ='default';
      var room_creator = '';
      var bans = [];
      var passwords = {};

      //adds user with prompt
      socketio.on('connect', function(){
         user = prompt("who are you?");
         socketio.emit('adduser', user);
      });


      //message received, now display
      // socketio.on("message_to_client", function(data) {
      //    document.getElementById("chatlog").appendChild(document.createElement("hr"));
      //    document.getElementById("chatlog").appendChild(document.createTextNode(data['message']));
      // });



      //update which chatroom user is in
      socketio.on("updateChat", function(username, data){
         $('#chatlog').append('<b>'+username+':</b> '+data+'<br>');
      });

      socketio.on("dm_client", function(target, from_user, message){
         if(target == user){
            $('#chatlog').append('<b>DM from: '+from_user+':</b> '+message+'<br>');
         }
         else if(from_user == user){
            $('#chatlog').append('<b>DM to: '+target+':</b> '+message+'<br>');
         }
         else{

         }
      });

      //updates users
      socketio.on('updateUsers', function(users, curuser){
         document.getElementById("AllUsers").innerHTML = '';
         document.getElementById("displayUser").innerHTML = "Hello, "+curuser;

         for(value in users){
            $("#AllUsers").html("<span>All Active Users: </span>");
            $("#RoomUsers").html("<span>Users in Room: </span>");
            $.each(users, function(key){
               if(key == user){
                  $("#AllUsers").append(key+', ');
               }
               else{
                  $("#AllUsers").append('<a href="#" onclick="openModal(\''+key+'\')">'+key+'</a>, ');
               }
               if(users[key] == room){
                  if(key == user){
                     $("#RoomUsers").append(key+', ');
                  }
                  else{
                     $("#RoomUsers").append('<a href="#" onclick="openModal(\''+key+'\')">'+key+'</a>, ');
                  }
               }
            });
         }
      });

      socketio.on('updateBans', function(newBans){
         bans = newBans;
         console.log(bans);
      });

      //when rooms updated, get and display
      socketio.on('updateRooms', function(rooms, curroom){
         room = curroom;
         room_creator = rooms[room];
         console.log('room created by: '+room_creator);
         $("#rooms").empty();
         $("#rooms").append("<div id='roomsHead'><b>Current Room: </b></div>");
         $.each(rooms, function(key, value){
            if(key == room){
               $("#roomsHead").append(key);
            }
            else{
               $("#rooms").append('<button onclick="switchRoom(\''+key+'\')"; return false;>'+key+'</button>');
            }
         });
      });


      socketio.on('createdroom', function(rooms){
         $("#rooms").empty();
         $("#rooms").append("<div id='roomsHead'><b>Current Room: </b></div>");
         $.each(rooms, function(key, value){
            if(key == room){
               $("#roomsHead").append(key);
            }
            else{
               $("#rooms").append('<button onclick="switchRoom(\''+key+'\')">'+key+'</button>');
            }
         });
      });

      socketio.on('kicking', function(target_user){
         if(user == target_user){
            socketio.emit('kick', user);
         }
      });

      socketio.on('banning', function(target_user, given_room){
         if(user == target_user && room == given_room){
            console.log("banning "+user);
            socketio.emit('ban', user, room);
         }
      });

      socketio.on('allPasswords', function(all_passwords){
         passwords = all_passwords;
      });

      socketio.on('clearChat', function(new_room){
         $('#chatlog').empty();
         $('#chatlog').append('<b>Now in '+new_room+'</b><br>');
      });

      function openModal(target_user){
         var modal = document.getElementById("userModal");
         modal.style.display = "block";

         //from http://www.w3schools.com/howto/howto_css_modals.asp
         window.onclick = function(event){
            if(event.target == modal){
               modal.style.display = "none";
            }
         }

         var dmbtn = document.getElementById("dm");
         var kickbtn = document.getElementById("kick");
         var banbtn = document.getElementById("ban");

         dmbtn.onclick = function(){
            var msg = document.getElementById("dmtext").value;
            socketio.emit("direct_message", msg, target_user, user);
         }

         kickbtn.onclick = function(){
            if(user == room_creator){
               socketio.emit("kick_setup", target_user, room);
            }
         }

         banbtn.onclick = function(){
            if(user == room_creator){
               socketio.emit("ban_setup", target_user, room);
            }
         }
      }
      
      function createRoom(){
         var p = prompt("Room password (leave blank for no password");
         var r = document.getElementById("newRoom").value;
         
            socketio.emit("create_room", r, user, p);
      }

      function switchRoom(sroom){
         if(passwords[sroom] == ''){
            room = sroom;
            socketio.emit('switchRoom', room, user);  
         }
         else{
            var p = prompt("Room Password");
            if(p == passwords[sroom]){
               room = sroom;
               socketio.emit('switchRoom', room, user);
            }
         }
         
      }

      function sendMessage(){
         var msg = document.getElementById("message_input").value;
         socketio.emit("message_to_server", {message:msg});
         document.getElementById("message_input").value = "";
      }
      </script>
</body>
</html>